# نظام إدارة المشتركين - دليل المطور

## نظرة عامة
تم تطوير نظام شامل لإدارة المشتركين في خدمات الكهرباء يتضمن جميع المتطلبات المحددة في المواصفات.

## المتطلبات المطبقة

### 1. نظام الأرقام المميزة للمشتركين
- **التنسيق**: `COMP{company_id}-SUB{subscriber_number}`
- **مثال**: `COMP16-SUB000001`, `COMP16-SUB000002`
- **الميزات**:
  - رقم فريد لكل مشترك داخل الشركة
  - ترقيم تسلسلي منفصل لكل شركة
  - حماية من التكرار باستخدام UNIQUE constraints

### 2. بيانات المشترك الأساسية

#### البيانات المطلوبة
- ✅ **الاسم الكامل** (full_name) - مطلوب
- ✅ **العنوان** (address) - مطلوب  
- ✅ **رقم الهاتف** (phone) - مطلوب
- ✅ **نوع النشاط** (business_type) - اختياري
  - سكني، تجاري، صناعي، زراعي، خدمي، حكومي
- ✅ **نوع نظام العداد** (meter_system_type) - اختياري
  - أحادي الطور، ثلاثي الطور، ذكي، رقمي
- ✅ **نوع التعرفة** (tariff_type) - اختياري  
  - الفئة الأولى (0-100 ك.و.س)
  - الفئة الثانية (101-300 ك.و.س)
  - الفئة الثالثة (301-500 ك.و.س)
  - الفئة الرابعة (أكثر من 500 ك.و.س)
  - تجاري، صناعي
- ✅ **مجموعة التعرفة** (tariff_group) - اختياري
  - مجموعة أ، مجموعة ب، مجموعة ج
- ✅ **رقم البطاقة الشخصية** (id_card_number) - اختياري
- ✅ **صورة المشترك** (photo_path) - اختياري
  - دعم رفع الصور من الكاميرا أو الجهاز
- ✅ **ملكية العقار** (property_ownership) - مطلوب
  - ملك أو إيجار

### 3. الجانب المحاسبي

#### مبلغ ربط التيار
- ✅ **مبلغ الربط** (connection_amount) - رقم عشري
- ✅ **القيود التلقائية** عند إضافة مشترك:

**القيد الأول - إثبات الإيراد:**
```
إيرادات ربط تيار للمشترك [اسم المشترك] - حساب رقم [رقم الحساب]
نوع المعاملة: connection_revenue
الرقم الإلكتروني: CON2025-000001
```

**القيد الثاني - استلام النقدية:**
```
استلام مبلغ ربط التيار من المشترك [اسم المشترك] - حساب رقم [رقم الحساب]  
نوع المعاملة: cash_receipt
الرقم الإلكتروني: CAS2025-000001
```

## التطبيق التقني

### 1. قاعدة البيانات

#### جدول المشتركين (subscribers)
```sql
CREATE TABLE subscribers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  company_id INTEGER NOT NULL,
  account_number TEXT NOT NULL,
  full_name TEXT NOT NULL,
  address TEXT NOT NULL,
  phone TEXT NOT NULL,
  business_type TEXT,
  meter_system_type TEXT,
  tariff_type TEXT,
  tariff_group TEXT,
  id_card_number TEXT,
  photo_path TEXT,
  property_ownership TEXT CHECK(property_ownership IN ('ملك', 'إيجار')),
  connection_amount DECIMAL(15,2) DEFAULT 0,
  is_active BOOLEAN DEFAULT 1,
  created_by INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (company_id) REFERENCES companies (id),
  FOREIGN KEY (created_by) REFERENCES users (id),
  UNIQUE(company_id, account_number)
);
```

### 2. الخدمات (Services)

#### SubscriberService
- **إضافة مشترك جديد** - `createSubscriber()`
- **جلب قائمة المشتركين** - `getSubscribersByCompany()`
- **البحث برقم الحساب** - `getSubscriberByAccountNumber()`
- **البحث بالمعرف** - `getSubscriberById()`
- **تحديث بيانات المشترك** - `updateSubscriber()`
- **إلغاء تفعيل المشترك** - `deactivateSubscriber()`

### 3. واجهات برمجة التطبيق (API)

#### نقاط النهاية (Endpoints)
- `POST /api/subscribers` - إضافة مشترك جديد
- `GET /api/subscribers` - جلب قائمة المشتركين
- `GET /api/subscribers/:id` - جلب مشترك بالمعرف
- `GET /api/subscribers/account/:accountNumber` - البحث برقم الحساب
- `PUT /api/subscribers/:id` - تحديث بيانات المشترك
- `DELETE /api/subscribers/:id` - إلغاء تفعيل المشترك

### 4. واجهة المستخدم

#### علامة تبويب إدارة المشتركين
- **نموذج إضافة مشترك جديد** مع جميع الحقول المطلوبة
- **قائمة المشتركين** مع عرض تفصيلي
- **وظيفة البحث** برقم الحساب أو الاسم
- **رفع الصور** من الكاميرا أو الجهاز
- **التحقق من صحة البيانات** قبل الحفظ

## اختبارات النظام

### اختبار الوظائف الأساسية
```bash
node test_subscribers.js
```

### اختبار المشتركين المتعددين
```bash  
node test_multiple_subscribers.js
```

### النتائج المؤكدة
- ✅ إنشاء أرقام حسابات فريدة
- ✅ حفظ بيانات المشتركين بالكامل
- ✅ إنشاء القيود المحاسبية التلقائية
- ✅ البحث والاستعلام بكفاءة
- ✅ عزل بيانات الشركات
- ✅ التحقق من صحة البيانات

## الميزات المتقدمة

### 1. الأمان وعزل البيانات
- كل شركة لها مشتركوها المنفصلون
- تطبيق مبدأ multi-tenant architecture
- التحقق من الصلاحيات عبر middleware

### 2. نظام الترقيم الإلكتروني
- أرقام إلكترونية فريدة للمعاملات المالية
- تنسيق `PREFIX2025-XXXXXX`
- عدادات منفصلة لكل شركة وكل نوع معاملة

### 3. واجهة مستخدم متجاوبة
- تصميم RTL للغة العربية  
- تحديث ديناميكي للبيانات
- رسائل تأكيد وتحذير باللغة العربية

## الملفات المضافة/المعدلة

1. **subscriberService.js** - خدمة إدارة المشتركين الكاملة
2. **database.js** - إضافة جدول المشتركين والدوال المرتبطة
3. **server.js** - إضافة 6 نقاط نهاية جديدة للمشتركين
4. **public/index.html** - واجهة إدارة المشتركين المتكاملة

## استنتاج

تم تطبيق جميع المتطلبات المحددة في المواصفات بنجاح، مما يوفر:
- نظام إدارة مشتركين شامل ومتكامل
- ربط محاسبي تلقائي لمبالغ الربط
- واجهة مستخدم سهلة الاستخدام
- أمان وعزل كامل للبيانات
- قابلية التوسع والصيانة

النظام جاهز للاستخدام الفوري ويمكن تطويره مستقبلاً لإضافة ميزات أخرى مثل:
- إدارة القراءات الشهرية
- نظام الفواتير
- تقارير الاستهلاك
- ربط المحافظ الإلكترونية